# lec16: lab6 spoc 思考题

- 有"spoc"标记的题是要求拿清华学分的同学在实体课上完成的，对于学堂在线的选课同学是可选题目。


## 视频相关思考题

### 16.1 总体介绍

1. 进程控制块中与调度相关的字段有哪些？在什么情况下会对其进行修改？

   答：volatile bool need_resched：在新进程被创建、运行时时间片结束或者等待时接收到所需资源时对其进行修改;uint32_t wait_state：在进程进入等待状态或从等待状态进入就绪状态时修改;list_entry_t run_link：对就绪队列进行初始化时修改; int time_slice：对时间片进行初始化时修改; skew_heap_entry_t lab6_run_pool：就绪对联改变时修改;uint32_t lab6_stride; 增加步长时修改;uint32_t lab6_priority：初始化或改变优先级时修改。                   

2. ucore的就绪队列数据结构在哪定义？在哪进行修改？

   答：在kern/schedule/sched.c中定义，在static struct run_queue __rq中进行修改。

3. ucore的等待队列数据结构在哪定义？在哪进行修改？

   答：在kern/schedule/sched.c中定义，在static list_entry_t timer_list中进行修改。

4. 尝试跟踪ucore中的调度过程。

   答：ucore中的调度过程为：中断响应、线程的中断现场保存、中断处理、调度触发、当前线程入队、选取下一个运行线程、下一个运行线程出队、线程切换、新线程的中断现场恢复、新线程的继续执行

### 16.2 调度算法支撑框架

1. 调度算法支撑框架中的各个函数指针的功能是啥？会被谁在何种情况下调用？

   答：初始化：会在创建新线程时被父线程调用、触发：会在时钟中断后被内核调用;选取：在原运行线程停止运行时被内核调用;出队：在选取新线程后被内核调用;入队：在原运行线程停止运行后被内核调用;切换：在在原运行线程停止运行后被内核调用。

2. 调度函数schedule()的调用函数分析，了解进程调度的原因。请分析ucore中所有可能的调度位置，并说明可能的调用原因。

   答：do_exit：当前运行进程退出执行;do_wait：父进程需等待子进程结束;cpu_idle：当前就绪队列中没有进程时调用;lock：当前进程想得到一个lock资源得不到之后调用;init_main：需等待孤儿进程结束;trap：产生时间中断时调用。

### 16.3 时间片轮转调度算法

1. 时间片轮转调度算法是如何基于调度算法支撑框架实现的？

   答：在初始化时设置时间片，`RR_proc_tick()`函数会维护时间片的修改，当时间片减为0时设置可调度标志为1,选取队列尾的第一项并出队，原线程置如队列头部，并切换到新选出的线程。

2. 时钟中断如何调用RR_proc_tick()的？

   答：时钟中断时会检查时间片的计数，到达零（时间片用完）时，设置可调度标志（need_resched）。

### 16.4 stride调度算法

1. stride调度算法的思路？

   答：stride调度算法是以步长为优先级的动态优先级调度算法；每次执行一个时间片，时间片用完时，优先级增加量为“步进”值，然后选取步长最小的线程作为新线程。

2. stride算法的特征是什么？

   答：动态优先级调度算法、确定的调度顺序、线程的执行时间与步进值的倒数成正比。

3. stride调度算法是如何避免stride溢出问题的？

   答：利用无符号数的有符号比较，从而避免步长值修改时的溢出处理。

4. 无符号数的有符号比较会产生什么效果？

   答：溢出时可以正常进行比较。

5. 什么是斜堆(skew heap)？斜堆在stride算法的实现中有什么用？

   答：斜堆的堆顶是优先级最小的节点；斜堆的合并时间开销为O(logN)，删除最小节点操作和插入操作都可以转换成合并操作，开销很小。

## 小组练习与思考题

### (1)(spoc) 跟踪和展现ucore的处理机调度过程

基于对“视频相关思考题”中16.2节第2小题的回答，在ucore执行处理机调度时，选择一种调度情况进行跟踪并显示上一个让出CPU线程的暂停代码位置和下一个进入执行状态线程的开始执行位置。

### (2)(spoc) 理解调度算法支撑框架的执行过程

即在ucore运行过程中通过`cprintf`函数来完整地展现出来多个进程在调度算法和框架的支撑下，在相关调度点如何动态调度和执行的细节。(越全面细致越好)

请完成如下练习，完成代码填写，并形成spoc练习报告
> 需写练习报告和简单编码，完成后放到git server 对应的git repo中

### 练习用的[lab6 spoc exercise project source code](https://github.com/chyyuu/ucore_lab/tree/master/labcodes_answer/lab6_result)


